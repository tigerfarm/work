# Twilio Functions using JWT for Authentication

I read through the following document, and I see that there are a number of steps.
Protect your Function with JSON Web Token
https://www.twilio.com/docs/serverless/functions-assets/quickstart/json-web-token
When protecting your public Function's sensitive data, it is important to consider some form of authentication to validate that only intended users are making requests.

The document has code samples for 2 Functions.
1. Code for /jwt: given a valid userid and password, generate and return a JWT token.
2. Code for /bearer: given a valid JWT token(generated by /jwt), process the request and respond with data.

The documentation /jwt sample code will generate a JWT token. JWT tokens are used for access to other Twilio Functions, in documentation, access to /bearer.

/bearer is a sample Twilio Function that requires a valid JWT token for access. If receiving a valid JWT token, process and respond to the request.

In an application it's common to have one program to generate JWT tokens to access the other application's programs. For example, /jwt is the Twilio Function to generate JWT tokens. Once a program has a JWT token, it can use that token to make requests to other functions, such as:
+ The sample function: /bearer.
+ You can create another function, such as, /getmore. /getmore would have the same token validation code as /bearer, however, it would process the request differently and then respond with different data.

One reason for using JWT tokens, is that they expire. Therefore, a token has a limited time span. Once the token expires, a program would need to make another request to get a new token (/jwt), and then use that token for future requests to program that require a valid JWT token.

I went the a test process.
I created 2 Twilio Functions using the code from the documentation.
Public Functions: /jwt and /bearer.

1. Code for /jwt:
https://www.twilio.com/docs/serverless/functions-assets/quickstart/json-web-token?code-sample=code-generate-a-json-web-token-for-function-authentication&code-language=Node.js&code-sdk-version=default
2. Code for /bearer
https://www.twilio.com/docs/serverless/functions-assets/quickstart/json-web-token?code-sample=code-authenticate-function-requests-using-bearer-authorization-and-jwt&code-language=Node.js&code-sdk-version=default

/jwt has the code to generate a JWT token that will be included as a header in the response.
Scenario:
+ A program (such as curl in the documentation) makes a request to your Twilio Function: /jwt. The request includes a username and password.
+ /jwt, receives the request.
+ Validates the username and password.
+ Generates a JWT token.
+ Responds to the request with a new JWT token, and response body: 'OK'.
response.setBody('OK').appendHeader('access_token', token);
````
curl -i -L -X POST 'https://test-2357.twil.io/jwt' \
-H 'Content-Type: application/json' \
--data-raw '{
    "username": "twilio",
    "password": "ahoy"
}'
Returns:
access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0d2lsaW8iLCJpc3MiOiJ0d2lsLmlvIiwib3JnIjoidHdpbGlvIiwicGVybXMiOlsicmVhZCJdLCJpYXQiOjE2NjI2NTc4NDQsImV4cCI6MTY2Mjc0NDI0NH0.3Ljfgp5eP7ekexG7jcAr0gwr4YFPq-6v8Dnk2E2Qnd0
... OK
````

+ The requesting program would receive the the new JWT token(access_token), and 
store it for use when making other application requests that require a valid JWT token.

/bearer is a Twilio Function that receives a token, validates the token, and then processes the request.
Scenario:
+ The program makes a request to your Twilio Function: /bearer, including the valid JWT token(access_token) in an HTTP header.
+ /bearer, receives the request.
+ Validates the JWT token.
+ If invalid, invalidate ('Unauthorized') response,
````
const setUnauthorized = (response) => {
  response
    .setBody('Unauthorized')
    ...
    );
  return response;
````
Or if valid, respond with the requested process response:
````
return callback(null, employeeSalaries);
````
Actually response JSON data received by the requesting program:
````
[{"username":"jdoe","salary":"$2000.00"},{"username":"mturner","salary":"$2500.00"}]
````
+ The requesting program receives and processes the response.

--------------------------------------------------------------------------------
### Use a Header to Contain the Username and Password

HTTP Authorization header,
https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization
````
Syntax:
Authorization: <auth-scheme> <authorization-parameters>
Basic authentication:
Authorization: Basic <credentials>
```` 
Format example:
https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization#basic_authentication

--------------------------------------------------------------------------------

Cheers...
